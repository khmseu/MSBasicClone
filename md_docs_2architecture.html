<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MSBasic - Applesoft BASIC Interpreter: MSBasic Architecture Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MSBasic - Applesoft BASIC Interpreter<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">A modern C++20 implementation of Applesoft II BASIC</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_2architecture.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">MSBasic Architecture Documentation</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md0"></a> </p>
<h1><a class="anchor" id="autotoc_md1"></a>
Overview</h1>
<p>MSBasic is a modern implementation of the Applesoft II BASIC interpreter written in C++20. The project aims to provide faithful Applesoft BASIC semantics while being portable across Linux, macOS, and Windows platforms. It supports both interactive REPL mode and script execution, with optional graphics rendering via Raylib.</p>
<h2><a class="anchor" id="autotoc_md2"></a>
Design Goals</h2>
<ol type="1">
<li><b>Applesoft II Compatibility</b>: Faithful reproduction of Applesoft BASIC behavior including:<ul>
<li>Variable name normalization (first 2 characters significant)</li>
<li>40-bit floating-point arithmetic</li>
<li>Classic control flow and data structures</li>
<li>Memory-mapped I/O simulation (PEEK/POKE/CALL)</li>
</ul>
</li>
<li><b>Cross-Platform Portability</b>: Clean separation between platform-specific and portable code, with consistent behavior across operating systems.</li>
<li><b>Test-Driven Development</b>: Comprehensive <code>.bas</code> test suite ensures correctness and prevents regressions.</li>
<li><b>Modern Implementation</b>: Leverages C++20 features while maintaining clarity and performance.</li>
</ol>
<h1><a class="anchor" id="autotoc_md3"></a>
System Architecture</h1>
<p>MSBasic follows a classic interpreter architecture with four main phases:</p>
<div class="fragment"><div class="line">Source Code → [Tokenizer] → Tokens → [Parser] → AST → [Interpreter] → Execution</div>
<div class="line">                                                           ↓</div>
<div class="line">                                                    [Variables/Memory]</div>
<div class="line">                                                           ↓</div>
<div class="line">                                                    [Graphics Subsystem]</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4"></a>
High-Level Components</h2>
<ol type="1">
<li><b><a class="el" href="classTokenizer.html" title="Converts BASIC source code into a stream of tokens.">Tokenizer</a></b> (<code><a class="el" href="tokenizer_8cpp.html" title="Lexical analyzer implementation for Applesoft BASIC.">src/tokenizer.cpp</a>/h</code>): Lexical analysis</li>
<li><b><a class="el" href="classParser.html" title="Recursive descent parser for BASIC syntax.">Parser</a></b> (<code><a class="el" href="parser_8cpp.html" title="Implementation of recursive descent parser for Applesoft BASIC.">src/parser.cpp</a>/h</code>): Syntax analysis and AST construction</li>
<li><b><a class="el" href="classInterpreter.html" title="Runtime execution engine for Applesoft BASIC programs.">Interpreter</a></b> (<code><a class="el" href="interpreter_8cpp.html" title="Implementation of the Applesoft BASIC runtime interpreter.">src/interpreter.cpp</a>/h</code>): Runtime execution engine</li>
<li><b><a class="el" href="classVariables.html" title="Storage and management for program variables, arrays, and functions.">Variables</a></b> (<code><a class="el" href="variables_8cpp.html" title="Implementation of variable, array, and function storage.">src/variables.cpp</a>/h</code>): Variable and array storage</li>
<li><b>Functions</b> (<code><a class="el" href="functions_8cpp.html" title="Implementation of Applesoft BASIC built-in functions and memory operations.">src/functions.cpp</a>/h</code>): Built-in function implementations</li>
<li><b>Statements</b> (<code><a class="el" href="statements_8cpp.html" title="Statement compilation unit (intentionally minimal)">src/statements.cpp</a>/h</code>): <a class="el" href="classStatement.html" title="Base class for all statement AST nodes.">Statement</a> execution classes</li>
<li><b><a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a></b> (<code><a class="el" href="graphics_8cpp.html" title="Implementation of Applesoft BASIC graphics operations.">src/graphics.cpp</a>/h</code>, <code><a class="el" href="graphics__renderer_8cpp.html" title="Platform-specific graphics rendering implementation using Raylib.">src/graphics_renderer.cpp</a>/h</code>): <a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a> subsystem</li>
<li><b><a class="el" href="classFloat40.html" title="Applesoft-compatible 40-bit floating point number.">Float40</a></b> (<code><a class="el" href="float40_8cpp.html" title="Implementation of 40-bit floating-point emulation.">src/float40.cpp</a>/h</code>): 40-bit floating-point emulation</li>
<li><b>Interactive</b> (<code><a class="el" href="interactive_8cpp.html" title="Interactive REPL (Read-Eval-Print Loop) mode implementation.">src/interactive.cpp</a>/h</code>): REPL mode implementation</li>
<li><b>Filesystem</b> (<code><a class="el" href="filesystem_8cpp.html" title="Cross-platform filesystem operations for BASIC file I/O.">src/filesystem.cpp</a>/h</code>): File I/O operations</li>
<li><b>Tape Manager</b> (<code><a class="el" href="tape__manager_8cpp.html" title="Implementation of cassette tape emulation for data persistence.">src/tape_manager.cpp</a>/h</code>): Cassette tape emulation</li>
</ol>
<h1><a class="anchor" id="autotoc_md5"></a>
Component Details</h1>
<h2><a class="anchor" id="autotoc_md6"></a>
1. Tokenizer</h2>
<p><b>Purpose</b>: Convert raw text into a stream of tokens for parsing.</p>
<p><b>Key Responsibilities</b>:</p>
<ul>
<li>Lexical analysis of BASIC source code</li>
<li>Keyword recognition (PRINT, IF, FOR, etc.)</li>
<li>Number and string literal parsing</li>
<li>Operator recognition (+, -, *, /, ^, MOD, etc.)</li>
<li>Identifier extraction with special handling for $, %, and FN prefixes</li>
</ul>
<p><b>Design Notes</b>:</p>
<ul>
<li>Single-pass tokenization</li>
<li>Line-aware for error reporting</li>
<li>Supports both immediate commands and program lines</li>
<li>Handles multi-statement lines (colon <code>:</code> separator)</li>
</ul>
<p><b>Key Classes/Functions</b>:</p>
<ul>
<li><code><a class="el" href="classTokenizer.html#a787b3a92435459ce30ba1be138f697c9" title="Tokenize a line of BASIC code.">Tokenizer::tokenize</a>(const std::string&amp; line)</code>: Main entry point</li>
<li><code><a class="el" href="classTokenizer.html#a456cff26a841ca3f5fd72f173637ccaa" title="Check if a string is a BASIC keyword.">Tokenizer::isKeyword()</a></code>: Keyword lookup</li>
<li><a class="el" href="structToken.html" title="Represents a single lexical token from the source code.">Token</a> type enumeration in <code><a class="el" href="types_8h.html" title="Core type definitions for the MSBasic interpreter.">types.h</a></code></li>
</ul>
<h2><a class="anchor" id="autotoc_md7"></a>
2. Parser</h2>
<p><b>Purpose</b>: Transform tokens into an Abstract Syntax Tree (AST).</p>
<p><b>Key Responsibilities</b>:</p>
<ul>
<li>Recursive descent parsing</li>
<li><a class="el" href="classExpression.html" title="Base class for all expression AST nodes.">Expression</a> parsing with proper operator precedence</li>
<li><a class="el" href="classStatement.html" title="Base class for all statement AST nodes.">Statement</a> parsing (PRINT, IF, FOR, GOSUB, etc.)</li>
<li>Error detection and reporting</li>
</ul>
<p><b><a class="el" href="classExpression.html" title="Base class for all expression AST nodes.">Expression</a> Parsing Hierarchy</b> (highest to lowest precedence):</p>
<ol type="1">
<li>Primary expressions (literals, variables, function calls, parentheses)</li>
<li>Power operator (^)</li>
<li>Unary operators (+, -, NOT)</li>
<li>Multiplicative operators (*, /, MOD)</li>
<li>Additive operators (+, -)</li>
<li>Relational operators (&lt;, &gt;, &lt;=, &gt;=, =, &lt;&gt;)</li>
<li>NOT operator</li>
<li>AND operator</li>
<li>OR operator</li>
</ol>
<p><b><a class="el" href="classStatement.html" title="Base class for all statement AST nodes.">Statement</a> Parsing</b>:</p>
<ul>
<li>Each statement type has a dedicated parser method (<code>parseIf()</code>, <code>parseFor()</code>, etc.)</li>
<li>Supports multi-statement lines via <code>parseStatement()</code> loop</li>
<li>Handles both numbered program lines and immediate mode commands</li>
</ul>
<p><b>Key Classes</b>:</p>
<ul>
<li><code><a class="el" href="classExpression.html" title="Base class for all expression AST nodes.">Expression</a></code>: Base class for all expression AST nodes</li>
<li><code><a class="el" href="classStatement.html" title="Base class for all statement AST nodes.">Statement</a></code>: Base class for all statement AST nodes</li>
<li><code><a class="el" href="classParser.html" title="Recursive descent parser for BASIC syntax.">Parser</a></code>: Main parser class with recursive descent methods</li>
</ul>
<h2><a class="anchor" id="autotoc_md8"></a>
3. Interpreter</h2>
<p><b>Purpose</b>: Execute the parsed AST and manage runtime state.</p>
<p><b>Key Responsibilities</b>:</p>
<ul>
<li>Program execution control (run, stop, continue)</li>
<li>Variable and array management via <code><a class="el" href="classVariables.html" title="Storage and management for program variables, arrays, and functions.">Variables</a></code> class</li>
<li>Control flow (GOTO, GOSUB/RETURN, FOR/NEXT, WHILE/WEND)</li>
<li>Data statement processing (DATA/READ/RESTORE)</li>
<li>Error handling (ONERR GOTO, RESUME)</li>
<li>I/O operations (PRINT, INPUT, GET)</li>
<li><a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a> mode coordination</li>
<li>Memory simulation (PEEK/POKE/CALL/WAIT)</li>
</ul>
<p><b>Execution Model</b>:</p>
<ul>
<li>Program stored as map of <code>LineNumber</code> → <code><a class="el" href="structProgramLine.html" title="Represents a single numbered line in a BASIC program.">ProgramLine</a></code></li>
<li>Program counter (<code>programCounter_</code>) iterates through sorted lines</li>
<li>Jump flag (<code>jumped_</code>) prevents auto-increment after GOTO/GOSUB</li>
<li>Stack-based GOSUB return tracking</li>
<li>Nested FOR loop management with stack</li>
</ul>
<p><b>State Management</b>:</p>
<ul>
<li><b>Running state</b>: <code>running_</code>, <code>paused_</code>, <code>immediate_</code></li>
<li><b>Execution position</b>: <code>currentLine_</code>, <code>programCounter_</code></li>
<li><b>Control stacks</b>: <code>gosubStack_</code>, <code>forStack_</code>, <code>whileStack_</code></li>
<li><b>Data handling</b>: <code>dataValues_</code>, <code>dataPointer_</code>, <code>dataOffsets_</code></li>
<li><b>Error handling</b>: <code>errorHandlerLine_</code>, <code>lastError_</code>, <code>errorLine_</code></li>
<li><b>Output state</b>: <code>outputColumn_</code>, <code>outputRow_</code>, text attributes</li>
<li><b>Memory bounds</b>: <code>lomem_</code>, <code>himem_</code></li>
</ul>
<p><b>Key Methods</b>:</p>
<ul>
<li><code>run()</code>: Execute program from start or current position</li>
<li><code>executeImmediate()</code>: Execute single command in immediate mode</li>
<li><code>gotoLine()</code>, <code>gosub()</code>, <code>returnFromGosub()</code>: Control flow</li>
<li><code>addLine()</code>, <code>deleteLine()</code>: Program editing</li>
<li><code>loadProgram()</code>, <code>saveProgram()</code>: File I/O</li>
</ul>
<h2><a class="anchor" id="autotoc_md9"></a>
4. Variables</h2>
<p><b>Purpose</b>: Store and manage program variables, arrays, and user-defined functions.</p>
<p><b>Key Responsibilities</b>:</p>
<ul>
<li>Variable storage (numeric, string, integer)</li>
<li>Multi-dimensional array support</li>
<li>Auto-dimensioning arrays to size 10</li>
<li>Variable name normalization (Applesoft convention)</li>
<li>User-defined function (DEF FN) storage</li>
</ul>
<p><b>Variable Name Normalization</b>:</p>
<ul>
<li>First 2 characters significant (case-insensitive)</li>
<li>Exception: FN names preserve 3-4 characters (FN prefix + 2 chars)</li>
<li>String suffix <code>$</code> preserved</li>
<li>Integer suffix <code>%</code> preserved</li>
</ul>
<p><b>Array Support</b>:</p>
<ul>
<li>Multi-dimensional arrays with arbitrary dimension count</li>
<li>Auto-DIM to size 10 per dimension if undeclared</li>
<li>Bounds checking with "BAD SUBSCRIPT" error</li>
<li>Sparse storage using <code>std::map&lt;std::vector&lt;int&gt;, <a class="el" href="classValue.html" title="Runtime value that can hold either a number or a string.">Value</a>&gt;</code></li>
</ul>
<p><b>User-Defined Functions</b>:</p>
<ul>
<li>Stored with parameter name and expression AST</li>
<li>Function calls substitute parameter value into expression</li>
<li>Naming follows FN conventions (FN prefix + 2 chars)</li>
</ul>
<p><b>Key Classes/Methods</b>:</p>
<ul>
<li><code>setVariable()</code>, <code>getVariable()</code>: Simple variable access</li>
<li><code>dimArray()</code>, <code>setArrayElement()</code>, <code>getArrayElement()</code>: Array operations</li>
<li><code>defineFunction()</code>, <code>getFunction()</code>: User function management</li>
<li><code>normalizeName()</code>: Applesoft-compatible name normalization</li>
</ul>
<h2><a class="anchor" id="autotoc_md10"></a>
5. Functions</h2>
<p><b>Purpose</b>: Implement all built-in functions (math, string, system).</p>
<p><b>Function Categories</b>:</p>
<p><b>Mathematical Functions</b>:</p>
<ul>
<li>Trigonometric: SIN, COS, TAN, ATN</li>
<li>Exponential/Logarithmic: EXP, LOG, SQR</li>
<li>Numeric: ABS, INT, SGN, RND</li>
</ul>
<p><b>String Functions</b>:</p>
<ul>
<li>Extraction: LEFT$, RIGHT$, MID$</li>
<li>Conversion: CHR$, ASC, STR$, VAL</li>
<li>Information: LEN</li>
</ul>
<p><b>System Functions</b>:</p>
<ul>
<li>Memory: PEEK, FRE</li>
<li>Screen: POS, SCRN</li>
<li>Hardware: PDL, USR (stubs)</li>
<li>Formatting: TAB, SPC</li>
</ul>
<p><b>Implementation</b>:</p>
<ul>
<li>Function evaluation occurs during expression evaluation</li>
<li>Functions are parsed as special expression nodes</li>
<li>Built-in functions have dedicated evaluator methods</li>
<li>User-defined functions (FN) stored in <a class="el" href="classVariables.html" title="Storage and management for program variables, arrays, and functions.">Variables</a> class</li>
</ul>
<h2><a class="anchor" id="autotoc_md11"></a>
6. Statements</h2>
<p><b>Purpose</b>: Define executable statement types and their behavior.</p>
<p><b><a class="el" href="classStatement.html" title="Base class for all statement AST nodes.">Statement</a> Types</b>:</p>
<p><b>Control Flow</b>:</p>
<ul>
<li>Conditional: IF/THEN/ELSE</li>
<li>Loops: FOR/NEXT, WHILE/WEND</li>
<li>Jumps: GOTO, GOSUB/RETURN, ON...GOTO/GOSUB</li>
<li>Stack manipulation: POP</li>
</ul>
<p><b>I/O</b>:</p>
<ul>
<li>Output: PRINT, HTAB, VTAB, HOME</li>
<li>Input: INPUT, GET</li>
<li>Text modes: INVERSE, NORMAL, FLASH</li>
</ul>
<p><b>Data Management</b>:</p>
<ul>
<li><a class="el" href="classVariables.html" title="Storage and management for program variables, arrays, and functions.">Variables</a>: LET (implicit assignment)</li>
<li>Arrays: DIM</li>
<li>Data: DATA, READ, RESTORE</li>
</ul>
<p><b><a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a></b>:</p>
<ul>
<li>Mode switching: GR, HIRES, HGR, HGR2, TEXT</li>
<li>Drawing: PLOT, HPLOT, HLIN, VLIN</li>
<li>Shapes: DRAW, XDRAW, MOVE, ROTATE, SCALE, SHLOAD</li>
<li>Color: COLOR=, HCOLOR=</li>
</ul>
<p><b>Program Control</b>:</p>
<ul>
<li>Execution: RUN, END, STOP, CONT</li>
<li>Editing: NEW, LIST, DEL</li>
<li>Files: LOAD, SAVE, CATALOG</li>
<li>Arrays: RECALL, STORE</li>
</ul>
<p><b>Memory/System</b>:</p>
<ul>
<li>Memory: POKE, CALL, WAIT</li>
<li>Bounds: LOMEM, HIMEM</li>
<li>Debugging: TRACE, NOTRACE, SPEED</li>
<li>Error handling: ONERR, RESUME</li>
<li>Devices: PR#, IN#</li>
<li>Tape: TAPE</li>
</ul>
<p><b>ProDOS Commands</b>:</p>
<ul>
<li>Files: CREATE, DELETE, RENAME, LOCK, UNLOCK</li>
<li>I/O: OPEN, CLOSE, READ, WRITE, APPEND, POSITION, FLUSH</li>
<li>Execution: EXEC, CHAIN, - (dash)</li>
<li>Directory: PREFIX, CAT</li>
</ul>
<p><b>Implementation</b>:</p>
<ul>
<li>Each statement type is a class derived from <code><a class="el" href="classStatement.html" title="Base class for all statement AST nodes.">Statement</a></code></li>
<li><code>execute()</code> method performs the statement's action</li>
<li>Statements access interpreter state via passed <code>Interpreter*</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md12"></a>
7. Graphics Subsystem</h2>
<p><b>Purpose</b>: Provide Apple II-compatible graphics rendering.</p>
<p><b>Architecture</b>:</p>
<ul>
<li>Two-tiered design: off-screen buffer + optional window rendering</li>
<li>Off-screen buffer always maintained for <a class="el" href="types_8h.html#aa520fbf142ba1e7e659590c07da31921acc06370fc7df708112ed2e2a79bc3b4c">SCRN()</a> queries</li>
<li>Window rendering via Raylib (optional, graceful fallback)</li>
</ul>
<p><b><a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a> Modes</b>:</p>
<ul>
<li><b>Text Mode</b>: 40-column or 80-column text</li>
<li><b>Low-Res Mode (GR)</b>: 40×40 pixels, 16 colors</li>
<li><b>High-Res Mode (HGR/HGR2)</b>: 280×192 pixels, 6 colors</li>
</ul>
<p><b>Rendering Pipeline</b>:</p>
<div class="fragment"><div class="line">Graphics Command → Graphics Buffer Update → Raylib Window Render</div>
</div><!-- fragment --><p><b>Key Components</b>:</p>
<ul>
<li><code><a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a></code> (singleton): Command interface and state management</li>
<li><code><a class="el" href="classGraphicsRenderer.html" title="Platform-specific graphics rendering implementation.">GraphicsRenderer</a></code>: Raylib rendering backend</li>
<li><code><a class="el" href="structGraphicsConfig.html" title="Configuration for graphics and text rendering.">GraphicsConfig</a></code>: Configuration (mode, scale, text columns)</li>
</ul>
<p><b>Shape Tables</b>:</p>
<ul>
<li>Binary format with vector data</li>
<li>ROTATE and SCALE transformations</li>
<li>DRAW (normal) and XDRAW (XOR) modes</li>
<li>SHLOAD from files or tape</li>
</ul>
<p><b>Text Rendering</b>:</p>
<ul>
<li>Ultimate Apple II Font (PrintChar21.ttf)</li>
<li>7×8 pixel character cells</li>
<li>40-column: 280 pixels wide</li>
<li>80-column: Horizontal compression to fit 280 pixels</li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
8. Float40</h2>
<p><b>Purpose</b>: Emulate Applesoft's 40-bit floating-point format.</p>
<p><b>Format</b>:</p>
<ul>
<li>5 bytes total</li>
<li>1 byte exponent (excess-128)</li>
<li>4 bytes mantissa (normalized)</li>
<li>Sign bit in high bit of mantissa</li>
</ul>
<p><b>Operations</b>:</p>
<ul>
<li>Addition, subtraction, multiplication, division</li>
<li>Conversion to/from IEEE 754 double</li>
<li>Comparison operations</li>
</ul>
<p><b>Design Notes</b>:</p>
<ul>
<li>Preserves Applesoft numerical behavior</li>
<li>Handles edge cases (zero, infinity, NaN)</li>
<li>Used internally for all numeric computations</li>
</ul>
<h2><a class="anchor" id="autotoc_md14"></a>
9. Interactive Mode</h2>
<p><b>Purpose</b>: Provide REPL (Read-Eval-Print Loop) interface.</p>
<p><b>Features</b>:</p>
<ul>
<li>Classic <code>]</code> prompt</li>
<li>Immediate command execution</li>
<li>Program line editing (numbered lines)</li>
<li>Command history</li>
<li>Tape change hotkey support</li>
</ul>
<p><b>Command Types</b>:</p>
<ul>
<li><b>Immediate commands</b>: Execute immediately (PRINT, LIST, RUN, etc.)</li>
<li><b>Program lines</b>: Stored with line numbers for later execution</li>
<li><b>Editing</b>: Line replacement or deletion</li>
</ul>
<p><b>Implementation</b>:</p>
<ul>
<li><code><a class="el" href="classInteractiveMode.html" title="Interactive REPL for Applesoft BASIC.">InteractiveMode</a></code> class manages REPL loop</li>
<li>Uses <code><a class="el" href="classInterpreter.html" title="Runtime execution engine for Applesoft BASIC programs.">Interpreter</a></code> for command execution</li>
<li>Handles line input and parsing</li>
<li>Supports both Unix and Windows console I/O</li>
</ul>
<h2><a class="anchor" id="autotoc_md15"></a>
10. Filesystem</h2>
<p><b>Purpose</b>: Provide file I/O operations for BASIC programs and data.</p>
<p><b>Supported Operations</b>:</p>
<ul>
<li>Program files: LOAD, SAVE</li>
<li>Directory listing: CATALOG, CAT</li>
<li>Binary files: BLOAD, BSAVE, BRUN</li>
<li>Array persistence: RECALL, STORE</li>
<li>ProDOS operations: CREATE, DELETE, RENAME, OPEN, CLOSE, etc.</li>
</ul>
<p><b>File Formats</b>:</p>
<ul>
<li>Text format for BASIC programs (line-numbered text)</li>
<li>Binary format for arrays (SIZE header + data)</li>
<li>Binary format for shape tables</li>
<li>Sequential tape format for STORE/RECALL/SHLOAD</li>
</ul>
<p><b>Cross-Platform</b>:</p>
<ul>
<li>Uses C++ standard library (std::filesystem, std::fstream)</li>
<li>Path normalization for different OSes</li>
<li>Native file dialogs via platform APIs (zenity, kdialog, osascript, COM)</li>
</ul>
<h2><a class="anchor" id="autotoc_md16"></a>
11. Tape Manager</h2>
<p><b>Purpose</b>: Emulate cassette tape for data persistence.</p>
<p><b>Features</b>:</p>
<ul>
<li>Sequential record format</li>
<li>Arrays: STORE/RECALL</li>
<li>Shape tables: SHLOAD</li>
<li>Position tracking across operations</li>
<li>File fallback when no tape loaded</li>
</ul>
<p><b>Tape Format</b>:</p>
<ul>
<li>Header: SIZE (4 bytes, little-endian)</li>
<li>Data: Variable-length record</li>
<li>Sequential access (rewind via TAPE command)</li>
</ul>
<p><b>Use Cases</b>:</p>
<ul>
<li>Save/load multiple arrays sequentially</li>
<li>Shape table distribution</li>
<li>Data persistence without explicit filenames</li>
</ul>
<h1><a class="anchor" id="autotoc_md17"></a>
Data Flow</h1>
<h2><a class="anchor" id="autotoc_md18"></a>
Program Execution Flow</h2>
<ol type="1">
<li><b>Load Phase</b>:<ul>
<li>Read source file or accept interactive input</li>
<li>Tokenize each line</li>
<li>Parse tokens into statements</li>
<li>Store in program map (LineNumber → <a class="el" href="structProgramLine.html" title="Represents a single numbered line in a BASIC program.">ProgramLine</a>)</li>
</ul>
</li>
<li><b>Data Collection Phase</b> (pre-run):<ul>
<li>Scan all DATA statements</li>
<li>Collect values into <code>dataValues_</code> vector</li>
<li>Build line → offset mapping for RESTORE</li>
</ul>
</li>
<li><b>Execution Phase</b>:<ul>
<li>Initialize program counter to first line</li>
<li>Loop through program lines:<ul>
<li>Apply SPEED delay if configured</li>
<li>Trace line number if TRACE enabled</li>
<li>Execute each statement in line</li>
<li>Update program counter (unless jumped)</li>
<li>Check for END or STOP</li>
</ul>
</li>
<li>Handle errors via ONERR if configured</li>
</ul>
</li>
<li><b>Control Flow</b>:<ul>
<li>GOTO: Jump to target line</li>
<li>GOSUB: Push return address, jump to subroutine</li>
<li>RETURN: Pop return address, resume execution</li>
<li>FOR/NEXT: Track loop state, auto-increment, check bounds</li>
<li>WHILE/WEND: Evaluate condition, loop or exit</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md19"></a>
Expression Evaluation Flow</h2>
<ol type="1">
<li>Parse expression into AST (recursive descent)</li>
<li>Evaluate AST (depth-first traversal):<ul>
<li>Literals: Return value directly</li>
<li><a class="el" href="classVariables.html" title="Storage and management for program variables, arrays, and functions.">Variables</a>: Lookup in <a class="el" href="classVariables.html" title="Storage and management for program variables, arrays, and functions.">Variables</a> class</li>
<li>Arrays: Evaluate subscripts, lookup element</li>
<li>Functions: Evaluate arguments, call function</li>
<li>Operators: Evaluate operands, apply operation</li>
</ul>
</li>
<li>Type coercion as needed (string/number)</li>
<li>Return final <a class="el" href="classValue.html" title="Runtime value that can hold either a number or a string.">Value</a></li>
</ol>
<h2><a class="anchor" id="autotoc_md20"></a>
Graphics Rendering Flow</h2>
<ol type="1">
<li><b>Command Reception</b>: <a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a> command executed (HPLOT, etc.)</li>
<li><b>Buffer Update</b>: Off-screen buffer modified</li>
<li><b>Window Update</b> (if Raylib available):<ul>
<li>Clear window</li>
<li>Iterate buffer pixels</li>
<li>Draw to Raylib texture</li>
<li>Display texture scaled</li>
<li>Poll events</li>
</ul>
</li>
<li><b>No-Graphics Fallback</b>: Command raises error if mode disabled</li>
</ol>
<h1><a class="anchor" id="autotoc_md21"></a>
Memory Model</h1>
<h2><a class="anchor" id="autotoc_md22"></a>
Variable Storage</h2>
<ul>
<li><a class="el" href="classVariables.html" title="Storage and management for program variables, arrays, and functions.">Variables</a> stored in <code>std::map&lt;std::string, <a class="el" href="classValue.html" title="Runtime value that can hold either a number or a string.">Value</a>&gt;</code> (normalized names)</li>
<li>Arrays stored separately in <code>std::map&lt;std::string, ArrayInfo&gt;</code></li>
<li>User functions stored in <code>std::map&lt;std::string, FunctionInfo&gt;</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md23"></a>
Program Storage</h2>
<ul>
<li>Program stored as <code>std::map&lt;LineNumber, <a class="el" href="structProgramLine.html" title="Represents a single numbered line in a BASIC program.">ProgramLine</a>&gt;</code></li>
<li>Sorted by line number for sequential execution</li>
<li>Each line contains: line number, source text, tokens, parsed statements</li>
</ul>
<h2><a class="anchor" id="autotoc_md24"></a>
Simulated Memory</h2>
<p>MSBasic simulates Apple II memory locations for compatibility:</p>
<p><b>Key Memory Locations</b>:</p>
<ul>
<li><b>$0069-$006A (105-106)</b>: LOMEM pointer</li>
<li><b>$0073-$0074 (115-116)</b>: HIMEM pointer</li>
<li><b>$00D8 (216)</b>: Error handler control</li>
<li><b>$00DA-$00DB (218-219)</b>: Error line number</li>
<li><b>$00DE (222)</b>: Error code</li>
<li><b>$C000 (49152/-16384)</b>: Last key pressed</li>
<li><b>$C010 (49168/-16368)</b>: Clear keyboard strobe</li>
<li><b>$C050-$C057</b>: <a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a> mode soft switches</li>
</ul>
<p><b>PEEK/POKE/CALL Implementation</b>:</p>
<ul>
<li>Simulated memory array (64KB)</li>
<li>Bounds checking against LOMEM/HIMEM</li>
<li>Special handling for control addresses</li>
<li>CALL is currently a no-op stub</li>
</ul>
<h2><a class="anchor" id="autotoc_md25"></a>
Data Segment</h2>
<ul>
<li>DATA values stored in <code>std::vector&lt;<a class="el" href="classValue.html" title="Runtime value that can hold either a number or a string.">Value</a>&gt;</code></li>
<li>Read pointer tracks current position</li>
<li>RESTORE can seek to specific line's data offset</li>
</ul>
<h1><a class="anchor" id="autotoc_md26"></a>
Build System</h1>
<h2><a class="anchor" id="autotoc_md27"></a>
CMake Configuration</h2>
<p><b>Key Features</b>:</p>
<ul>
<li>C++20 requirement</li>
<li>Optional Raylib auto-build via FetchContent</li>
<li>Font auto-fetch from kreativekorp.com</li>
<li>Cross-platform support (Linux, macOS, Windows)</li>
<li>CTest integration for <code>.bas</code> test suite</li>
</ul>
<p><b>Version Management</b>:</p>
<ul>
<li>Git-based versioning: <code>git describe --tags --dirty --always</code></li>
<li>Fallback to default or override</li>
<li>Embedded in <code>version.h</code> header</li>
</ul>
<p><b>Dependencies</b>:</p>
<ul>
<li>Raylib 5.0+ (optional, auto-built)</li>
<li>X11 libraries (Linux only, for Raylib)</li>
<li>Standard C++20 toolchain</li>
</ul>
<p><b>Build Targets</b>:</p>
<ul>
<li><code>msbasic</code>: Main executable</li>
<li>CTest tests: Each <code>.bas</code> file in <code>tests/</code> and <code>examples/</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md28"></a>
Font Integration</h2>
<p><b>Automatic Font Fetching</b>:</p>
<ul>
<li>CMake module: <code>cmake/FetchFont.cmake</code></li>
<li>Downloads Ultimate Apple II Font at configure time</li>
<li>Caches in <code>assets/fonts/</code></li>
<li>Idempotent (skips if already present)</li>
<li>Graceful fallback on failure</li>
</ul>
<p><b>Font Files</b>:</p>
<ul>
<li><code>PrintChar21.ttf</code>: TrueType font (~50KB)</li>
<li><code>apple2-charset.html</code>: Character set reference</li>
<li><code>FreeLicense.txt</code>: License file</li>
</ul>
<p><b>CI/CD Integration</b>:</p>
<ul>
<li>GitHub Actions cache for fonts</li>
<li>Cache key based on <code>FetchFont.cmake</code> hash</li>
<li>Speeds up CI builds</li>
</ul>
<h1><a class="anchor" id="autotoc_md29"></a>
Testing Strategy</h1>
<h2><a class="anchor" id="autotoc_md30"></a>
Test Suite</h2>
<p><b>Location</b>: <code>tests/</code> and <code>examples/</code> directories</p>
<p><b>Test Types</b>:</p>
<ol type="1">
<li><b>Language Feature Tests</b>: Arrays, loops, conditionals, functions, etc.</li>
<li><b><a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a> Tests</b>: Drawing, modes, shapes</li>
<li><b>System Tests</b>: PEEK/POKE, memory, errors</li>
<li><b>File I/O Tests</b>: LOAD/SAVE, arrays, ProDOS commands</li>
<li><b>Example Programs</b>: Demonstrations and edge cases</li>
</ol>
<p><b>Execution</b>:</p>
<ul>
<li>CTest runs each <code>.bas</code> file</li>
<li>Success: Program exits with code 0</li>
<li>Failure: Non-zero exit or runtime error</li>
</ul>
<p><b>Coverage</b>:</p>
<ul>
<li>75+ test programs</li>
<li>~98% feature coverage</li>
<li>Core language features: 100%</li>
<li><a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a>: 100%</li>
<li>ProDOS: 100%</li>
</ul>
<h2><a class="anchor" id="autotoc_md31"></a>
Manual Testing</h2>
<ul>
<li>Interactive mode: REPL correctness</li>
<li><a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a> rendering: Visual inspection</li>
<li>Cross-platform: Linux, macOS, Windows builds</li>
<li>No-graphics mode: Headless operation</li>
</ul>
<h1><a class="anchor" id="autotoc_md32"></a>
Cross-Platform Considerations</h1>
<h2><a class="anchor" id="autotoc_md33"></a>
Platform-Specific Code</h2>
<p><b>Conditional Compilation</b>:</p>
<ul>
<li><code>PLATFORM_LINUX</code>, <code>PLATFORM_MACOS</code>, <code>PLATFORM_WINDOWS</code> defines</li>
<li>Guards for Windows vs. POSIX APIs</li>
</ul>
<p><b>Platform Differences</b>:</p>
<p><b>Windows</b>:</p>
<ul>
<li>Virtual Terminal mode for ANSI support</li>
<li>Console API for cursor positioning</li>
<li>COM file dialogs</li>
</ul>
<p><b>Linux/macOS (POSIX)</b>:</p>
<ul>
<li>ANSI escape sequences</li>
<li>X11 for graphics (Linux)</li>
<li>Cocoa for graphics (macOS)</li>
<li>zenity/kdialog/osascript for file dialogs</li>
</ul>
<h2><a class="anchor" id="autotoc_md34"></a>
Portability Techniques</h2>
<ol type="1">
<li><b>Standard Library First</b>: Use C++ standard library when possible</li>
<li><b>Platform Guards</b>: <code>#ifdef</code> blocks for OS-specific code</li>
<li><b>Abstraction Layers</b>: <a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a> subsystem hides platform details</li>
<li><b>Graceful Degradation</b>: Fallbacks for missing features</li>
<li><b>CI/CD Testing</b>: GitHub Actions tests Linux, macOS, Windows</li>
</ol>
<h1><a class="anchor" id="autotoc_md35"></a>
Error Handling</h1>
<h2><a class="anchor" id="autotoc_md36"></a>
Error Types</h2>
<p><b>Syntax Errors</b>:</p>
<ul>
<li>Detected during tokenization/parsing</li>
<li>Reported immediately</li>
<li>Prevent program execution</li>
</ul>
<p><b>Runtime Errors</b>:</p>
<ul>
<li>Type mismatch</li>
<li>Division by zero</li>
<li>Out of memory</li>
<li>Bad subscript</li>
<li>Undefined statement/function</li>
<li><a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a> not enabled</li>
<li>File I/O errors</li>
</ul>
<p><b>ProDOS Error Codes</b>:</p>
<ul>
<li>Range: 2-21</li>
<li>Stored in memory location 222</li>
<li>Examples: PATH NOT FOUND, DISK FULL, FILE LOCKED</li>
</ul>
<h2><a class="anchor" id="autotoc_md37"></a>
Error Handling Flow</h2>
<ol type="1">
<li><b>No Handler</b>: Print error message, stop execution</li>
<li><b>ONERR GOTO n</b>: Jump to error handler line</li>
<li><b>Error State</b>: Store error code, error line</li>
<li><b>RESUME</b>: Continue execution from error line or next line</li>
</ol>
<h2><a class="anchor" id="autotoc_md38"></a>
Error Recovery</h2>
<ul>
<li>ONERR GOTO 0: Disable error handler</li>
<li>POKE 216,0: Restore normal error handling</li>
<li>CLR: Clear all state including error handler</li>
</ul>
<h1><a class="anchor" id="autotoc_md39"></a>
Performance Considerations</h1>
<h2><a class="anchor" id="autotoc_md40"></a>
Optimizations</h2>
<ol type="1">
<li><b>Tokenization</b>: Single-pass, minimal allocations</li>
<li><b>Variable Lookup</b>: Hash map (O(1) average)</li>
<li><b>Array Storage</b>: Sparse map (memory-efficient)</li>
<li><b>Program Storage</b>: Sorted map (O(log n) line lookup)</li>
<li><b><a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a> Buffer</b>: Direct pixel access, minimal copying</li>
</ol>
<h2><a class="anchor" id="autotoc_md41"></a>
Bottlenecks</h2>
<ol type="1">
<li><b><a class="el" href="classExpression.html" title="Base class for all expression AST nodes.">Expression</a> Evaluation</b>: Recursive AST traversal</li>
<li><b><a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a> Rendering</b>: Pixel-by-pixel updates</li>
<li><b>String Operations</b>: Frequent allocations</li>
<li><b><a class="el" href="classFloat40.html" title="Applesoft-compatible 40-bit floating point number.">Float40</a> Arithmetic</b>: Non-native format conversion</li>
</ol>
<h2><a class="anchor" id="autotoc_md42"></a>
Scalability</h2>
<ul>
<li>Handles programs with thousands of lines</li>
<li>Arrays limited by available memory</li>
<li><a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a>: Fixed 280×192 buffer (minimal overhead)</li>
</ul>
<h1><a class="anchor" id="autotoc_md43"></a>
Future Enhancements</h1>
<h2><a class="anchor" id="autotoc_md44"></a>
Potential Improvements</h2>
<ol type="1">
<li><b>JIT Compilation</b>: Translate AST to native code</li>
<li><b>Bytecode VM</b>: Intermediate representation</li>
<li><b>Optimizing <a class="el" href="classParser.html" title="Recursive descent parser for BASIC syntax.">Parser</a></b>: Constant folding, dead code elimination</li>
<li><b>Native Float</b>: Option to use IEEE 754 instead of <a class="el" href="classFloat40.html" title="Applesoft-compatible 40-bit floating point number.">Float40</a></li>
<li><b>Sound Support</b>: BELL enhancement, tone generation</li>
<li><b>Network I/O</b>: TCP/IP extensions</li>
<li><b>Debugger</b>: Breakpoints, watch expressions, step-through</li>
<li><b>More <a class="el" href="classGraphics.html" title="Singleton managing graphics state and operations.">Graphics</a></b>: Enhanced shape tables, sprites</li>
<li><b>Plugin System</b>: Loadable extensions</li>
<li><b>Documentation</b>: Generate API docs with Doxygen</li>
</ol>
<h2><a class="anchor" id="autotoc_md45"></a>
Backward Compatibility</h2>
<ul>
<li>Maintain Applesoft semantics</li>
<li>Support legacy programs</li>
<li>Optional modern extensions (flags/pragmas)</li>
</ul>
<h1><a class="anchor" id="autotoc_md46"></a>
References</h1>
<ul>
<li><a class="el" href="md_docs_2features.html">Implementation Features</a></li>
<li><a class="el" href="index.html#md_README">README</a></li>
</ul>
<p>Additional reference materials for Applesoft BASIC (commands, functions, language features, error messages, and memory addresses) are available in the Research folder but are not included in the API documentation.</p>
<h1><a class="anchor" id="autotoc_md47"></a>
Glossary</h1>
<ul>
<li><b>AST</b>: Abstract Syntax Tree - hierarchical representation of program structure</li>
<li><b>BASIC</b>: Beginner's All-purpose Symbolic Instruction Code</li>
<li><b><a class="el" href="classFloat40.html" title="Applesoft-compatible 40-bit floating point number.">Float40</a></b>: 40-bit floating-point format used by Applesoft BASIC</li>
<li><b>HIMEM</b>: High memory boundary for BASIC program/variables</li>
<li><b>LOMEM</b>: Low memory boundary for BASIC program/variables</li>
<li><b>PEEK/POKE</b>: Read/write memory directly by address</li>
<li><b>ProDOS</b>: Apple II disk operating system with extended commands</li>
<li><b>REPL</b>: Read-Eval-Print Loop - interactive command interface</li>
<li><b><a class="el" href="classTokenizer.html" title="Converts BASIC source code into a stream of tokens.">Tokenizer</a></b>: Component that converts text to tokens</li>
<li><b><a class="el" href="classParser.html" title="Recursive descent parser for BASIC syntax.">Parser</a></b>: Component that converts tokens to AST</li>
<li><b><a class="el" href="classInterpreter.html" title="Runtime execution engine for Applesoft BASIC programs.">Interpreter</a></b>: Component that executes AST</li>
</ul>
<hr  />
<p>Last Updated: 2025-12-21 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Dec 23 2025 21:11:32 for MSBasic - Applesoft BASIC Interpreter by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
