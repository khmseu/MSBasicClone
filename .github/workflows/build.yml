name: Build, Test & Docs

on:
  push:
    branches: [main]
    tags: [v*]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # ============================================================================
  # Build & Test Matrix (Linux, macOS, Windows)
  # ============================================================================
  build:
    name: Build & Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            display: Linux
          - os: macos-latest
            display: macOS
          - os: windows-latest
            display: Windows

    steps:
      - uses: actions/checkout@v4

      - name: Cache Apple II fonts
        uses: actions/cache@v4
        with:
          path: assets/fonts
          key: apple2-fonts-${{ hashFiles('cmake/FetchFont.cmake') }}
          restore-keys: |
            apple2-fonts-

      - name: Install X11 and GL dependencies (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libgl1-mesa-dev

      - name: Configure and build
        run: |
          cmake -S . -B build
          # Use Release configuration on multi-config generators (MSVC/Visual Studio)
          cmake --build build --config Release

      - name: Run tests
        run: |
          # ctest needs the configuration on multi-config generators
          ctest --test-dir build -C Release --output-on-failure

  # ============================================================================
  # Build Docs (HTML + PDF)
  # Always build both on Ubuntu (PDF requires LaTeX)
  # ============================================================================
  build-docs:
    name: Build Docs (HTML + PDF)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Install Doxygen and LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            doxygen \
            graphviz \
            texlive-xetex \
            texlive-luatex \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-font-utils

      - name: Configure and build (HTML + PDF)
        run: |
          cmake -S . -B build-docs
          cmake --build build-docs --target docs

      - name: Upload HTML docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-html
          path: docs/api/html
          retention-days: 30

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-pdf
          path: docs/api/latex/refman.pdf
          retention-days: 30

      - name: Upload Pages artifact (for Pages fallback)
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/api/html

  # PDF Docs job removed â€” PDFs are built in `build-docs` (Ubuntu) and uploaded as artifacts
  # The legacy `docs-pdf` job has been deleted to avoid duplication and simplify CI

  # ============================================================================
  # Deploy to GitHub Pages (on v* tags only)
  # ============================================================================
  deploy:
    name: Deploy Docs to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload HTML docs artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/api/html

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Confirm deployment
        shell: bash
        run: |
          echo "Deployed: ${{ steps.deployment.outputs.page_url }}"
          if [ -z "${{ steps.deployment.outputs.page_url }}" ]; then
            echo "WARN: deployment URL not provided"
          fi
