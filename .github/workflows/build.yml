name: Build, Test & Docs

on:
  push:
    branches: [main]
    tags: [v*]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # ============================================================================
  # Build & Test Matrix (Linux, macOS, Windows)
  # ============================================================================
  build:
    name: Build & Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            display: Linux
          - os: macos-latest
            display: macOS
          - os: windows-latest
            display: Windows

    steps:
      - uses: actions/checkout@v4

      - name: Cache Apple II fonts
        uses: actions/cache@v4
        with:
          path: assets/fonts
          key: apple2-fonts-${{ hashFiles('cmake/FetchFont.cmake') }}
          restore-keys: |
            apple2-fonts-

      - name: Install X11 and GL dependencies (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libgl1-mesa-dev

      - name: Configure and build
        run: |
          cmake -S . -B build
          # Use Release configuration on multi-config generators (MSVC/Visual Studio)
          cmake --build build --config Release

      - name: Run tests
        run: |
          # ctest needs the configuration on multi-config generators
          ctest --test-dir build -C Release --output-on-failure

  # ============================================================================
  # HTML Docs (on push/PR; HTML-only, no PDF to skip LaTeX deps)
  # ============================================================================
  docs-html:
    name: Build HTML Docs
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen

      - name: Configure and build (HTML only, no PDF)
        run: |
          cmake -S . -B build-docs -DDOCS_BUILD_PDF=OFF
          cmake --build build-docs --target docs

      - name: Upload HTML docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-html
          path: docs/api/html
          retention-days: 30

  # ============================================================================
  # Publish HTML Docs every time they're built
  # ============================================================================
  publish-html:
    name: Publish HTML Docs
    runs-on: ubuntu-latest
    needs: docs-html

    steps:
      - name: Download HTML artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-html
          path: ./html-artifact

      - name: Extract HTML artifact
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p html-artifact/contents
          archive=$(ls html-artifact | head -n1 || true)
          if [ -z "$archive" ]; then
            echo "No artifact file found in html-artifact/"
            exit 1
          fi
          echo "Found artifact: $archive"

          # Try common archive formats, else handle plain files/directories
          case "$archive" in
            *.zip)
              unzip -q html-artifact/$archive -d html-artifact/contents ;;
            *.tar|*.tar.gz|*.tgz)
              tar -xzf html-artifact/$archive -C html-artifact/contents ;;
            *.tar.bz2)
              tar -xjf html-artifact/$archive -C html-artifact/contents ;;
            *)
              if [ -d "html-artifact/$archive" ]; then
                echo "Artifact is a directory; copying contents"
                cp -r html-artifact/$archive/. html-artifact/contents/
              elif [ -f "html-artifact/$archive" ]; then
                echo "Artifact is a single file; copying into contents/"
                cp html-artifact/$archive html-artifact/contents/
              elif file html-artifact/$archive | grep -q "tar archive"; then
                tar -xf html-artifact/$archive -C html-artifact/contents
              else
                echo "Unknown archive format: $archive"
                exit 1
              fi ;;
          esac

      - name: Publish HTML to gh-pages (peaceiris)
        if: ${{ github.event_name != 'pull_request' }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./html-artifact/contents
          publish_branch: gh-pages
          allow_empty_commit: false
          keep_files: false
          force_orphan: false
          enable_jekyll: false

      - name: Skip publish on pull requests
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          echo "Skipping publishing to gh-pages for pull_request events (GITHUB_TOKEN may not have push permission)."

  # ============================================================================
  # PDF Docs (on v* tags only; slower, includes LaTeX)
  # ============================================================================
  docs-pdf:
    name: Build PDF Docs
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Install Doxygen and LaTeX/epstopdf
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            doxygen \
            graphviz \
            texlive-xetex \
            texlive-luatex \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-font-utils

      - name: Configure and build (with PDF)
        run: |
          cmake -S . -B build-docs
          cmake --build build-docs --target docs

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-pdf
          path: docs/api/latex/refman.pdf
          retention-days: 30

      - name: Upload HTML artifact (for Pages)
        # Use the latest major to avoid deprecated upload-artifact v3 dependency
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/api/html

  # ============================================================================
  # Deploy to GitHub Pages (on v* tags only)
  # ============================================================================
  deploy-pages:
    name: Deploy Docs to GitHub Pages
    runs-on: ubuntu-latest
    needs: docs-pdf
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Wait for Pages artifact
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          owner="${{ github.repository_owner }}"
          repo="${{ github.event.repository.name }}"
          runid="${{ github.run_id }}"

          echo "Waiting for 'github-pages' artifact to appear for run $runid..."
          for i in {1..36}; do
            artifacts=$(gh api repos/$owner/$repo/actions/runs/$runid/artifacts --jq '.artifacts[].name' 2>/dev/null || true)
            if echo "$artifacts" | grep -qw "github-pages"; then
              echo "Found 'github-pages' artifact"
              exit 0
            fi
            echo "Not found yet (attempt $i/36), sleeping 5s"
            sleep 5
          done

          echo "Artifact 'github-pages' not found after retries"
          echo "Available artifacts:" 
          gh api repos/$owner/$repo/actions/runs/$runid/artifacts --jq '.artifacts[] | {id: .id, name: .name}' || true
          exit 1

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      # Small pause to avoid rare artifact indexing races between services
      - name: Wait a moment for artifact propagation
        if: success() || failure()
        run: |
          echo "Sleeping 15s to allow artifact service to propagate"
          sleep 15

      # Fallback: if deploy-pages fails to fetch the signed artifact URL, try
      # downloading the artifact and publishing with peaceiris/actions-gh-pages
      - name: Download Pages artifact (fallback)
        if: failure()
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: ./pages-artifact

      - name: Extract downloaded Pages artifact (fallback)
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p pages-artifact/contents
          archive=$(ls pages-artifact | head -n1 || true)
          if [ -z "$archive" ]; then
            echo "No artifact file found in pages-artifact/"
            exit 1
          fi
          echo "Found artifact: $archive"

          # Try common archive formats, else handle plain files/directories
          case "$archive" in
            *.zip)
              unzip -q pages-artifact/$archive -d pages-artifact/contents ;;
            *.tar|*.tar.gz|*.tgz)
              tar -xzf pages-artifact/$archive -C pages-artifact/contents ;;
            *.tar.bz2)
              tar -xjf pages-artifact/$archive -C pages-artifact/contents ;;
            *)
              if [ -d "pages-artifact/$archive" ]; then
                echo "Artifact is a directory; copying contents"
                cp -r pages-artifact/$archive/. pages-artifact/contents/
              elif [ -f "pages-artifact/$archive" ]; then
                echo "Artifact is a single file; copying into contents/"
                cp pages-artifact/$archive pages-artifact/contents/
              elif file pages-artifact/$archive | grep -q "tar archive"; then
                tar -xf pages-artifact/$archive -C pages-artifact/contents
              else
                echo "Unknown archive format: $archive"
                exit 1
              fi ;;
          esac

      - name: Fallback publish via git (PAT preferred)
        if: failure()
        shell: bash
        env:
          REPO: ${{ github.repository }}
          OWNER: ${{ github.repository_owner }}
          GIT_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
          GIT_NAME: "github-actions[bot]"
        run: |
          set -euo pipefail

          # Prefer a user-supplied PAT if present, otherwise use GITHUB_TOKEN
          if [ -n "${{ secrets.PAGES_PAT }}" ]; then
            TOKEN="${{ secrets.PAGES_PAT }}"
          else
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
          fi

          echo "Using token from selected secret to push gh-pages"

          # Prepare a temporary git worktree for publishing
          git config --global user.email "$GIT_EMAIL"
          git config --global user.name "$GIT_NAME"

          # Clone the gh-pages branch (or create an orphan branch if missing)
          TARGET_DIR="gh-pages-tmp"
          rm -rf "$TARGET_DIR"
          set +e
          git clone --depth=1 --branch=gh-pages "https://x-access-token:${TOKEN}@github.com/${REPO}.git" "$TARGET_DIR"
          CLONE_STATUS=$?
          set -e

          if [ $CLONE_STATUS -ne 0 ]; then
            echo "gh-pages branch not found or clone failed; creating orphan branch"
            mkdir -p "$TARGET_DIR"
            git init "$TARGET_DIR"
            pushd "$TARGET_DIR" >/dev/null
            git checkout --orphan gh-pages
            popd >/dev/null
          fi

          # Sync files
          rm -rf "$TARGET_DIR"/*
          cp -r pages-artifact/contents/. "$TARGET_DIR/" || true

          pushd "$TARGET_DIR" >/dev/null
          git add --all
          if git diff --quiet --cached; then
            echo "No changes to publish"
            popd >/dev/null
            exit 0
          fi
          git commit -m "Publish site from ${GITHUB_SHA}"
          # Force push to allow branch protection rules to be satisfied by PAT
          git push "https://x-access-token:${TOKEN}@github.com/${REPO}.git" HEAD:gh-pages --force
          popd >/dev/null

      - name: Fallback publish to GitHub Pages (peaceiris)
        if: failure()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./pages-artifact/contents
