name: Build & Test

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Cache Apple II fonts
              uses: actions/cache@v4
              with:
                  path: assets/fonts
                  key: apple2-fonts-${{ hashFiles('cmake/FetchFont.cmake') }}
                  restore-keys: |
                      apple2-fonts-

            - name: Install X11 and GL dependencies for Raylib
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    libx11-dev \
                    libxrandr-dev \
                    libxinerama-dev \
                    libxcursor-dev \
                    libxi-dev \
                    libgl1-mesa-dev

            - name: Build msbasic
              run: |
                  mkdir build
                  cd build
                  cmake ..
                  cmake --build . --target msbasic

            - name: Run tests
              run: |
                  cd build
                  ctest --output-on-failure
