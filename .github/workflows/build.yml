name: Build, Test & Docs

on:
  push:
    branches: [main]
    tags: [v*]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # ============================================================================
  # Build & Test Matrix (Linux, macOS, Windows)
  # ============================================================================
  build:
    name: Build & Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            display: Linux
          - os: macos-latest
            display: macOS
          - os: windows-latest
            display: Windows

    steps:
      - uses: actions/checkout@v4

      - name: Cache Apple II fonts
        uses: actions/cache@v4
        with:
          path: assets/fonts
          key: apple2-fonts-${{ hashFiles('cmake/FetchFont.cmake') }}
          restore-keys: |
            apple2-fonts-

      - name: Install X11 and GL dependencies (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libgl1-mesa-dev

      - name: Configure and build
        run: |
          cmake -S . -B build
          # Use Release configuration on multi-config generators (MSVC/Visual Studio)
          cmake --build build --config Release

      - name: Run tests
        run: |
          # ctest needs the configuration on multi-config generators
          ctest --test-dir build -C Release --output-on-failure

  # ============================================================================
  # HTML Docs (on push/PR; HTML-only, no PDF to skip LaTeX deps)
  # ============================================================================
  docs-html:
    name: Build HTML Docs
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen

      - name: Configure and build (HTML only, no PDF)
        run: |
          cmake -S . -B build-docs -DDOCS_BUILD_PDF=OFF
          cmake --build build-docs --target docs

      - name: Upload HTML docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-html
          path: docs/api/html
          retention-days: 30

  # ============================================================================
  # PDF Docs (on v* tags only; slower, includes LaTeX)
  # ============================================================================
  docs-pdf:
    name: Build PDF Docs
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Install Doxygen and LaTeX/epstopdf
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            doxygen \
            graphviz \
            texlive-xetex \
            texlive-luatex \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-font-utils

      - name: Configure and build (with PDF)
        run: |
          cmake -S . -B build-docs
          cmake --build build-docs --target docs

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-pdf
          path: docs/api/latex/refman.pdf
          retention-days: 30

      - name: Upload HTML artifact (for Pages)
        # Use the latest major to avoid deprecated upload-artifact v3 dependency
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/api/html

  # ============================================================================
  # Deploy to GitHub Pages (on v* tags only)
  # ============================================================================
  deploy-pages:
    name: Deploy Docs to GitHub Pages
    runs-on: ubuntu-latest
    needs: docs-pdf
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Wait for Pages artifact
        shell: bash
        run: |
          owner="${{ github.repository_owner }}"
          repo="${{ github.event.repository.name }}"
          runid="${{ github.run_id }}"

          echo "Waiting for 'github-pages' artifact to appear for run $runid..."
          for i in {1..12}; do
            artifacts=$(gh api repos/$owner/$repo/actions/runs/$runid/artifacts --jq '.artifacts[].name' 2>/dev/null || true)
            if echo "$artifacts" | grep -qw "github-pages"; then
              echo "Found 'github-pages' artifact"
              exit 0
            fi
            echo "Not found yet (attempt $i/12), sleeping 5s"
            sleep 5
          done

          echo "Artifact 'github-pages' not found after retries"
          echo "Available artifacts:" 
          gh api repos/$owner/$repo/actions/runs/$runid/artifacts --jq '.artifacts[] | {id: .id, name: .name}' || true
          exit 1

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
